name: MEDUSA CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggers

jobs:
  test-installation:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Display Python version
      run: python --version

    - name: Install MEDUSA
      run: |
        python -m pip install --upgrade pip
        python -m pip install -e .

    - name: Verify MEDUSA installation
      run: |
        medusa --version
        medusa --help

    - name: Test init command
      run: |
        cd /tmp
        mkdir test-project
        cd test-project
        echo 'print("Hello, World!")' > test.py
        echo 'n' | medusa init --ide claude-code --force
        test -f .medusa.yml && echo "âœ… Config created"

    - name: Test scan command
      run: |
        cd /tmp/test-project
        medusa scan . --workers 2

    - name: Test install --check command
      run: medusa install --check

  test-docker:
    name: Test Docker Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image (simple)
      run: |
        python -m pip install --upgrade pip build
        python -m build --wheel
        docker build -f Dockerfile.simple -t medusa:test .

    - name: Test Docker image
      run: |
        docker run --rm medusa:test --version
        docker run --rm medusa:test --help

    - name: Test Docker scan
      run: |
        docker run --rm -v $(pwd):/workspace medusa:test scan /workspace --workers 2

  test-multi-distro:
    name: Test Multi-Distribution
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build wheel
      run: |
        python -m pip install --upgrade pip build
        python -m build --wheel

    - name: Run multi-distro tests
      run: |
        chmod +x test-docker-install.sh
        bash test-docker-install.sh

  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dev dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install black ruff mypy

    - name: Check code formatting with black
      run: black --check medusa/ || true

    - name: Lint with ruff
      run: ruff check medusa/ || true

    - name: Type check with mypy
      run: mypy medusa/ || true
